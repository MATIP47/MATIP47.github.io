<!DOCTYPE html>
<html>
<head>
  <title>Color Changer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      text-align: center;
      padding-top: 30px;
      transition: background 0.3s, color 0.3s;
      margin: 0;
      font-family: sans-serif;
    }
    #history {
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid currentColor;
      padding: 5px;
      margin: 0 auto;
      border-radius: 5px;
      text-align: left;
      width: 90%;
      box-sizing: border-box;
    }
    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin: 4px 0;
      font-family: monospace;
    }
    .history-left {
      display: flex;
      align-items: center;
    }
    .swatch {
      width: 20px;
      height: 20px;
      border: 1px solid #000;
      margin-right: 8px;
      border-radius: 3px;
      transition: box-shadow 0.3s;
    }
    .hex, .rgb {
      margin-right: 5px;
      cursor: pointer;
      transition: text-shadow 0.3s;
    }
    .rgb {
      font-size: 0.9em;
      color: #555;
    }
    .timestamp {
      font-size: 0.8em;
      margin-left: 8px;
    }
    #colorCode span {
      cursor: pointer;
      font-family: monospace;
    }
  </style>
</head>
<body onclick="changeColor()">
  <h1>Click anywhere!</h1>
  <p id="colorCode">
    Current Color: 
    <span class="hex" onclick="event.stopPropagation(); copyText(this)">#FFFFFF</span> 
    (<span class="rgb" onclick="event.stopPropagation(); copyText(this)">rgb(255, 255, 255)</span>)
    <span id="copiedMsg" style="margin-left:10px; font-size:0.9em; color:green;"></span>
  </p>
  <button onclick="clearHistory(event)">Clear History</button>
  <button onclick="downloadHistory(event)">Download History</button>

  <h2 style="margin-top:30px;">History</h2>
  <div id="history">
    <!-- History items appear here -->
  </div>

  <script>
    function hexToRgb(hex) {
      let r = parseInt(hex.substr(1,2),16);
      let g = parseInt(hex.substr(3,2),16);
      let b = parseInt(hex.substr(5,2),16);
      return `rgb(${r}, ${g}, ${b})`;
    }

    function changeColor(color=null) {
      if(!color) {
        color = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
      }
      let rgb = hexToRgb(color);
      document.body.style.backgroundColor = color;
      let mainHex = document.querySelector("#colorCode .hex");
      let mainRgb = document.querySelector("#colorCode .rgb");
      mainHex.textContent = color;
      mainRgb.textContent = rgb;

      addToHistory(color);
      saveHistory();

      let [r,g,b] = rgb.match(/\d+/g).map(Number);
      let brightness = (r*299 + g*587 + b*114)/1000;
      document.body.style.color = brightness > 128 ? "black" : "white";
    }

    function copyText(element){
      let text = element.textContent;
      navigator.clipboard.writeText(text).then(()=>{
        let msg = document.getElementById("copiedMsg");
        msg.textContent = "Copied!";

        // Flash main display if it's the clicked element
        if(element.parentElement.id === "colorCode") {
          element.style.textShadow = `0 0 8px ${text}`;
          setTimeout(()=> element.style.textShadow = '', 500);
        }

        // Flash swatch in history if exists
        let historyItems = document.querySelectorAll("#history .history-item");
        historyItems.forEach(item=>{
          if(item.querySelector(".hex").textContent === text || item.querySelector(".rgb").textContent === text){
            let swatch = item.querySelector(".swatch");
            swatch.style.boxShadow = `0 0 10px 3px ${text}`;
            setTimeout(()=>{ swatch.style.boxShadow = ''; }, 500);
          }
        });

        setTimeout(()=> msg.textContent="", 1000);
      });
    }

    function addToHistory(color, timestamp=null) {
      let history = document.getElementById("history");
      if(history.firstChild && history.firstChild.querySelector(".hex").textContent === color) return;
      if(!timestamp) timestamp = new Date().toLocaleString();

      let rgb = hexToRgb(color);

      let item = document.createElement("div");
      item.className = "history-item";

      let left = document.createElement("div");
      left.className = "history-left";

      let swatch = document.createElement("span");
      swatch.className = "swatch";
      swatch.style.backgroundColor = color;

      let hexText = document.createElement("span");
      hexText.className = "hex";
      hexText.textContent = color;
      hexText.onclick = e => { e.stopPropagation(); copyText(hexText); };

      let rgbText = document.createElement("span");
      rgbText.className = "rgb";
      rgbText.textContent = rgb;
      rgbText.onclick = e => { e.stopPropagation(); copyText(rgbText); };

      left.appendChild(swatch);
      left.appendChild(hexText);
      left.appendChild(rgbText);

      let timeText = document.createElement("span");
      timeText.className = "timestamp";
      timeText.textContent = timestamp;

      item.appendChild(left);
      item.appendChild(timeText);

      item.onclick = e => { e.stopPropagation(); changeColor(color); };

      history.prepend(item);
      setTimeout(()=>{ item.scrollIntoView({behavior:"smooth", block:"start"}); }, 50);
    }

    function saveHistory() {
      let colors=[], timestamps=[];
      document.querySelectorAll("#history .hex").forEach(el=>{
        colors.push(el.textContent);
        timestamps.push(el.parentElement.parentElement.querySelector(".timestamp").textContent);
      });
      localStorage.setItem("colorHistory", JSON.stringify(colors));
      localStorage.setItem("colorTimestamps", JSON.stringify(timestamps));
    }

    function loadHistory() {
      let savedColors = localStorage.getItem("colorHistory");
      let savedTimes = localStorage.getItem("colorTimestamps");
      if(savedColors && savedTimes) {
        let colors = JSON.parse(savedColors);
        let timestamps = JSON.parse(savedTimes);
        for(let i=colors.length-1; i>=0; i--){
          addToHistory(colors[i], timestamps[i]);
        }
      }
    }

    function clearHistory(e) {
      e.stopPropagation();
      document.getElementById("history").innerHTML="";
      localStorage.removeItem("colorHistory");
      localStorage.removeItem("colorTimestamps");
    }

    function downloadHistory(e){
      e.stopPropagation();
      let colors=[], timestamps=[];
      document.querySelectorAll("#history .hex").forEach(el=>{
        colors.push(el.textContent);
        timestamps.push(el.parentElement.parentElement.querySelector(".timestamp").textContent);
      });
      if(colors.length===0){alert("No colors to download!"); return;}
      let lines = colors.map((hex,i)=>`${hex} - ${hexToRgb(hex)} - ${timestamps[i]}`);
      let blob = new Blob([lines.join("\n")],{type:"text/plain"});
      let link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="color-history.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.onload = ()=>{
      loadHistory();
      let last = document.querySelector("#history .hex");
      if(last) changeColor(last.textContent);
    };
  </script>
</body>
</html>
