<script>
    const terminal = document.getElementById("terminal");
    let dropdown = document.getElementById("dropdown");
    let input = document.getElementById("commandInput");

    const availableCommands = ["help", "about", "clear"];
    let commandHistory = [];
    let historyIndex = -1;
    let dropdownIndex = -1;
    let currentMatches = [];

    input.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            if (dropdown.style.display === "flex" && dropdownIndex >= 0) {
                input.value = currentMatches[dropdownIndex];
            }
            processCommand(input.value);
            hideDropdown();
        } else if (event.key === "ArrowUp") {
            if (dropdown.style.display === "flex") {
                navigateDropdown(-1);
            } else if (commandHistory.length > 0) {
                historyIndex = (historyIndex <= 0) ? commandHistory.length - 1 : historyIndex - 1;
                input.value = commandHistory[historyIndex];
            }
            event.preventDefault();
        } else if (event.key === "ArrowDown") {
            if (dropdown.style.display === "flex") {
                navigateDropdown(1);
            } else if (commandHistory.length > 0) {
                historyIndex = (historyIndex >= commandHistory.length - 1) ? 0 : historyIndex + 1;
                input.value = commandHistory[historyIndex];
            }
            event.preventDefault();
        } else if (event.key === "Tab") {
            event.preventDefault();
            handleTabAutocomplete(event.shiftKey ? -1 : 1); // Shift+Tab = backwards
        }
    });

    function processCommand(commandValue) {
        const command = commandValue.trim().toLowerCase();

        if (commandValue.trim() !== "") {
            commandHistory.push(commandValue);
            historyIndex = commandHistory.length;
        }

        const executedLine = document.createElement("div");
        executedLine.textContent = "user@homebrew:~$ " + commandValue;
        terminal.insertBefore(executedLine, document.getElementById("currentLine"));

        const output = document.createElement("div");
        if (command === "help") {
            output.textContent = "Available commands: " + availableCommands.join(", ");
        } else if (command === "about") {
            output.textContent = "This is a homebrew terminal-style website with neon green text!";
        } else if (command === "clear") {
            terminal.innerHTML = "";
            terminal.appendChild(createNewInputLine());
            scrollToBottom();
            return;
        } else if (command.length > 0) {
            output.textContent = "Command not found: " + command;
        }

        if (output.textContent) terminal.insertBefore(output, document.getElementById("currentLine"));
        input.value = "";
        hideDropdown();
        scrollToBottom();
    }

    function createNewInputLine() {
        const newLine = document.createElement("div");
        newLine.className = "input-line";
        newLine.id = "currentLine";

        const prompt = document.createElement("span");
        prompt.className = "prompt";
        prompt.textContent = "user@homebrew:~$";

        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.id = "commandInput";
        newInput.autofocus = true;

        const cursor = document.createElement("span");
        cursor.className = "cursor";

        const newDropdown = document.createElement("div");
        newDropdown.className = "dropdown";
        newDropdown.id = "dropdown";

        newLine.appendChild(prompt);
        newLine.appendChild(newInput);
        newLine.appendChild(cursor);
        newLine.appendChild(newDropdown);

        input = newInput;
        dropdown = newDropdown;
        dropdownIndex = -1;
        currentMatches = [];

        newInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                if (dropdown.style.display === "flex" && dropdownIndex >= 0) {
                    input.value = currentMatches[dropdownIndex];
                }
                processCommand(newInput.value);
                hideDropdown();
            } else if (event.key === "Tab") {
                event.preventDefault();
                handleTabAutocomplete(event.shiftKey ? -1 : 1); // Shift+Tab
            } else if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                event.preventDefault();
            }
        });

        return newLine;
    }

    function handleTabAutocomplete(direction = 1) {
        const filter = input.value.trim().toLowerCase();

        if (dropdown.style.display !== "flex") {
            currentMatches = availableCommands.filter(cmd => cmd.startsWith(filter));
            if (currentMatches.length === 0) return;
            showDropdown(currentMatches);
            dropdownIndex = (direction === 1 ? 0 : currentMatches.length - 1);
            highlightDropdownItem();
        } else {
            dropdownIndex += direction;
            if (dropdownIndex < 0) dropdownIndex = currentMatches.length - 1;
            if (dropdownIndex >= currentMatches.length) dropdownIndex = 0;
            highlightDropdownItem();
        }
    }

    function showDropdown(matches) {
        dropdown.innerHTML = "";
        matches.forEach((cmd, i) => {
            const item = document.createElement("div");
            item.textContent = cmd;
            item.className = "dropdown-item";
            if (i === dropdownIndex) item.classList.add("active");
            item.addEventListener("click", () => {
                input.value = cmd;
                hideDropdown();
                input.focus();
            });
            dropdown.appendChild(item);
        });
        dropdown.style.display = "flex";
        dropdown.style.flexDirection = "column";
    }

    function hideDropdown() {
        dropdown.style.display = "none";
        dropdownIndex = -1;
        currentMatches = [];
    }

    function highlightDropdownItem() {
        const items = dropdown.querySelectorAll(".dropdown-item");
        items.forEach((item, i) => {
            item.classList.toggle("active", i === dropdownIndex);
        });
        input.value = currentMatches[dropdownIndex];
    }

    function navigateDropdown(direction) {
        if (currentMatches.length === 0) return;
        dropdownIndex += direction;
        if (dropdownIndex < 0) dropdownIndex = currentMatches.length - 1;
        if (dropdownIndex >= currentMatches.length) dropdownIndex = 0;
        highlightDropdownItem();
    }

    function scrollToBottom() {
        terminal.scrollTop = terminal.scrollHeight;
    }

    scrollToBottom();
</script>
